# v0.2.0 Framework Pattern Documentation

## Overview

The v0.2.0 framework pattern is an alternative bootstrap approach used by some
scripts in the odb_datasafe extension. This pattern uses a "minimal bootstrap"
structure optimized for complex, multi-target operations.

**Scripts Using v0.2.0 Pattern:**

- `ds_target_move.sh`
- `ds_target_audit_trail.sh`
- `ds_target_connect_details.sh`
- `ds_target_details.sh`

## Key Differences from Standard Pattern

### Bootstrap Differences

**Standard Pattern:**

```bash
# Bootstrap - locate library files (must be before version check)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Script identification
SCRIPT_NAME="script_name"
SCRIPT_VERSION="$(grep '^version:' "${SCRIPT_DIR}/../.extension" 2>/dev/null | awk '{print $2}' | tr -d '\n' || echo '0.5.4')"

# Load framework libraries
if [[ ! -f "${LIB_DIR}/ds_lib.sh" ]]; then
    echo "[ERROR] Cannot find ds_lib.sh in ${LIB_DIR}" >&2
    exit 1
fi
source "${LIB_DIR}/ds_lib.sh"
```

**v0.2.0 Pattern:**

```bash
# --- Minimal bootstrap: ensure SCRIPT_BASE and libraries ----------------------
if [[ -z "${SCRIPT_BASE:-}" || -z "${SCRIPT_LIB_DIR:-}" ]]; then
    _SRC="${BASH_SOURCE[0]}"
    SCRIPT_BASE="$(cd "$(dirname "${_SRC}")/.." > /dev/null 2>&1 && pwd)"
    SCRIPT_LIB_DIR="${SCRIPT_BASE}/lib"
    unset _SRC
fi

# Load the odb_datasafe v0.2.0 framework
if [[ -r "${SCRIPT_LIB_DIR}/ds_lib.sh" ]]; then
    # shellcheck disable=SC1090
    source "${SCRIPT_LIB_DIR}/ds_lib.sh" || {
        echo "ERROR: ds_lib.sh failed to load." >&2
        exit 1
    }
else
    echo "ERROR: ds_lib.sh not found (tried: ${SCRIPT_LIB_DIR}/ds_lib.sh)" >&2
    exit 1
fi
```

### Variable Naming

| Standard Pattern                   | v0.2.0 Pattern      |
|------------------------------------|---------------------|
| `SCRIPT_DIR`                       | `SCRIPT_BASE`       |
| `LIB_DIR`                          | `SCRIPT_LIB_DIR`    |
| `SCRIPT_VERSION` from `.extension` | Hardcoded in header |

### Configuration Precedence

**v0.2.0 Pattern Configuration Order:**

1. Code defaults (lowest precedence)
2. `.env` file
3. Config file (e.g., `etc/ds_target_move.conf`)
4. CLI arguments (highest precedence)

**Standard Pattern:**
Similar order but typically uses `init_config()` function call.

## When to Use Each Pattern

### Use Standard Pattern When

- Creating new, simple scripts
- Single-target operations
- Straightforward CRUD operations
- Following template-based development

### Use v0.2.0 Pattern When

- Complex multi-target batch operations
- Advanced dependency management
- Existing v0.2.0 scripts need modifications
- Need external configuration flexibility

## v0.2.0 Pattern Features

### 1. Minimal Bootstrap Check

The pattern checks if `SCRIPT_BASE` and `SCRIPT_LIB_DIR` are already set, allowing external orchestration:

```bash
if [[ -z "${SCRIPT_BASE:-}" || -z "${SCRIPT_LIB_DIR:-}" ]]; then
    # Initialize only if not already set
    _SRC="${BASH_SOURCE[0]}"
    SCRIPT_BASE="$(cd "$(dirname "${_SRC}")/.." > /dev/null 2>&1 && pwd)"
    SCRIPT_LIB_DIR="${SCRIPT_BASE}/lib"
    unset _SRC
fi
```

**Benefit**: Scripts can be sourced or orchestrated by parent scripts without re-initializing.

### 2. Explicit Configuration Defaults

Configuration is explicitly documented at the top with `: "${VAR:=default}"` syntax:

```bash
# --- Code defaults (lowest precedence; overridden by .env/CONF/CLI) ----------
: "${OCI_CLI_CONFIG_FILE:=${HOME}/.oci/config}"
: "${OCI_CLI_PROFILE:=DEFAULT}"

: "${COMPARTMENT:=}"         # source compartment name or OCID
: "${TARGETS:=}"             # CSV names/OCIDs (overrides compartment mode)
: "${STATE_FILTERS:=ACTIVE}" # CSV lifecycle states when scanning compartment
: "${DEST_COMPARTMENT:=}"    # destination compartment name or OCID (required)

: "${MOVE_DEPENDENCIES:=true}" # move audit trails, assessments, policies
: "${CONTINUE_ON_ERROR:=true}" # continue processing other targets if one fails
: "${FORCE:=false}"            # skip confirmation prompts
```

**Benefit**: Clear documentation of all configuration options with defaults.

### 3. Specialized Helper Functions

v0.2.0 scripts often include specialized functions for complex operations:

**Example from `ds_target_move.sh`:**

- `ds_build_target_list()` - Build list from compartment or CSV
- `ds_validate_and_fill_targets()` - Resolve and validate targets
- `move_target_with_dependencies()` - Complex multi-resource move

## Example: ds_target_move.sh Structure

```bash
#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# Header with metadata
# ------------------------------------------------------------------------------

# --- Code defaults (lowest precedence) ---------------------------------------
: "${COMPARTMENT:=}"
: "${TARGETS:=}"
: "${DEST_COMPARTMENT:=}"
: "${MOVE_DEPENDENCIES:=true}"

# Runtime variables
COMP_OCID=""
COMP_NAME=""
DEST_COMP_OCID=""
moved_count=0
failed_count=0

# --- Minimal bootstrap -------------------------------------------------------
if [[ -z "${SCRIPT_BASE:-}" || -z "${SCRIPT_LIB_DIR:-}" ]]; then
    _SRC="${BASH_SOURCE[0]}"
    SCRIPT_BASE="$(cd "$(dirname "${_SRC}")/.." > /dev/null 2>&1 && pwd)"
    SCRIPT_LIB_DIR="${SCRIPT_BASE}/lib"
    unset _SRC
fi

# Load framework
if [[ -r "${SCRIPT_LIB_DIR}/ds_lib.sh" ]]; then
    source "${SCRIPT_LIB_DIR}/ds_lib.sh" || exit 1
else
    echo "ERROR: ds_lib.sh not found" >&2
    exit 1
fi

# --- Functions ---------------------------------------------------------------
Usage() { ... }
parse_args() { ... }
validate_inputs() { ... }
ds_build_target_list() { ... }       # Specialized
ds_validate_and_fill_targets() { ... }  # Specialized
move_target_with_dependencies() { ... } # Specialized
do_work() { ... }

# --- Main --------------------------------------------------------------------
main() {
    init_config
    parse_args "$@"
    validate_inputs
    do_work
}

main "$@"
```

## Migration Guidelines

### From v0.2.0 to Standard Pattern

If you need to migrate a v0.2.0 script to the standard pattern:

1. **Update Bootstrap:**

   ```bash
   # OLD (v0.2.0)
   if [[ -z "${SCRIPT_BASE:-}" ]]; then
       SCRIPT_BASE="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
       SCRIPT_LIB_DIR="${SCRIPT_BASE}/lib"
   fi
   
   # NEW (Standard)
   SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
   LIB_DIR="${SCRIPT_DIR}/../lib"
   SCRIPT_VERSION="$(grep '^version:' "${SCRIPT_DIR}/../.extension" 2>/dev/null | awk '{print $2}' | tr -d '\n' || echo '0.5.4')"
   ```

2. **Update Variable References:**
   - Change `SCRIPT_BASE` → `SCRIPT_DIR`
   - Change `SCRIPT_LIB_DIR` → `LIB_DIR`
   - Add version reading from `.extension`

3. **Update Function Headers:**
   - Use standardized format (see `doc/standardization_pattern.md`)

4. **Add Resolution Helpers:**
   - Use `resolve_compartment_to_vars()`
   - Use `resolve_target_to_vars()`

### From Standard to v0.2.0 Pattern

Only needed for complex, multi-target batch operations. Generally not recommended
unless there's a specific architectural need.

## Best Practices for v0.2.0 Scripts

1. **Document Configuration Clearly:**
   - Use comments to explain precedence
   - Group related configuration variables

2. **Maintain Consistency:**
   - If modifying v0.2.0 scripts, keep the pattern
   - Don't mix patterns within the same script

3. **Test Orchestration:**
   - Ensure scripts work when SCRIPT_BASE is pre-set
   - Test sourcing from parent scripts

4. **Version Management:**
   - Consider migrating hardcoded versions to `.extension`
   - Document version in script header

## Compatibility Notes

### Shared Library Compatibility

Both patterns use the same library functions:

- `lib/ds_lib.sh` (main loader)
- `lib/common.sh` (logging, utilities)
- `lib/oci_helpers.sh` (OCI operations)

The libraries work with both `SCRIPT_DIR`/`LIB_DIR` and `SCRIPT_BASE`/`SCRIPT_LIB_DIR`.

### Function Compatibility

Resolution helper functions work with both patterns:

- `resolve_compartment_to_vars()`
- `resolve_target_to_vars()`
- `oci_exec()` and `oci_exec_ro()`

## Future Considerations

### Consolidation Path

The project may eventually standardize on one pattern. When that happens:

1. **If standardizing on Standard Pattern:**
   - Migrate v0.2.0 scripts systematically
   - Preserve specialized functions
   - Update documentation

2. **If keeping both:**
   - Document clear guidelines for when to use each
   - Ensure library compatibility
   - Maintain examples of both

## Summary

| Feature       | Standard Pattern        | v0.2.0 Pattern                  |
|---------------|-------------------------|---------------------------------|
| Complexity    | Simple                  | Complex                         |
| Bootstrap     | Direct                  | Conditional                     |
| Variables     | `SCRIPT_DIR`, `LIB_DIR` | `SCRIPT_BASE`, `SCRIPT_LIB_DIR` |
| Version       | From `.extension`       | Hardcoded                       |
| Configuration | `init_config()`         | Explicit defaults               |
| Use Case      | New scripts             | Complex batch ops               |
| Orchestration | No                      | Yes                             |
| Template      | `template.sh`           | `ds_target_move.sh`             |

## References

- [Standard Pattern Documentation](standardization_pattern.md)
- [Script Standardization Status](script_standardization_status.md)
- [template.sh](../bin/template.sh) - Standard pattern example
- [ds_target_move.sh](../bin/ds_target_move.sh) - v0.2.0 pattern example
