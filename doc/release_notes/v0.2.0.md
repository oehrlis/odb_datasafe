# Release Notes - odb_datasafe v0.2.0

**Release Date:** 2026-01-09  
**Type:** Major Feature Release + Performance & UX Improvements

## üéØ Key Features

### 1. New Scripts (v0.2.0 Framework)

#### üìã `ds_target_list.sh` - Target Listing & Analysis

- **List Mode (Default):** Show detailed target information in table format

  ```bash
  ds_target_list.sh                    # Show target list (default)
  ds_target_list.sh -q                 # Quiet mode (no INFO messages)
  ds_target_list.sh -d                 # Debug mode (verbose logging)
  ```

- **Count Mode:** Summary by lifecycle state with totals (use `-C` flag)

  ```bash
  ds_target_list.sh -C                 # Show count summary
  # Output: ACTIVE: 1172, NEEDS_ATTENTION: 14, TOTAL: 1186
  ```

- **Output Formats:** Table, JSON, or CSV

  ```bash
  ds_target_list.sh                    # Table format (default)
  ds_target_list.sh -f json            # JSON format  
  ds_target_list.sh -f csv             # CSV format
  ```

- **Flexible Filtering:** Lifecycle (-L), custom fields (-F), specific targets (-T)
- **Performance:** 38% code reduction vs legacy version (~400 vs ~650 lines)

#### üè∑Ô∏è `ds_target_update_tags.sh` - Tag Management  

- **Pattern-Based Environment Detection:** Derives environment from compartment names

  ```bash
  cmp-lzp-dbso-prod-projects ‚Üí Environment=prod
  cmp-lzp-dbso-test-projects ‚Üí Environment=test
  cmp-lzp-dbso-qs-projects   ‚Üí Environment=qs
  ```

- **Dry-Run Mode (Default):** Show changes without applying

  ```bash
  ds_target_update_tags.sh             # Dry-run mode
  ds_target_update_tags.sh --apply     # Apply changes
  ```

- **Configurable Tags:** Namespace, field names, and values
- **Progress Tracking:** Counter display for bulk operations

#### üìä `ds_tg_report.sh` - Comprehensive Tag Reports

- **Multiple Report Types:**

  ```bash
  ds_tg_report.sh -r env               # Environment distribution
  ds_tg_report.sh -r undef             # Undefined tag values
  ds_tg_report.sh -r missing           # Missing tag namespaces
  ```

- **Output Formats:** table|json|csv for integration with other tools
- **Environment Analysis:** Distribution summary (487 prod, 355 qs, 344 test)

### 2. Performance Improvements (9x Faster)

#### ‚ö° Async Operations by Default

- **Before:** `WAIT_FOR_COMPLETION=true` (blocking on each target)
- **After:** `WAIT_FOR_COMPLETION=false` (async by default)
- **Impact:** 9x faster bulk operations (90s ‚Üí 10s for 9 targets)

#### üéõÔ∏è Wait Control Options

```bash
ds_target_refresh.sh                  # Async (default)
ds_target_refresh.sh --wait           # Wait for completion
ds_target_refresh.sh --no-wait        # Explicit async
```

### 3. UX Improvements (50% More Concise)

#### üìù Consolidated Messaging

- **Before:** Two lines per target + JSON clutter

  ```text
  [INFO] [1/7] Processing: ocid1.datasafe...
  [INFO] Refreshing: target_name (async)
  {
    "opc-work-request-id": "ocid1.work..."
  }
  ```

- **After:** Single clean line per target

  ```text
  [INFO] [1/7] Refreshing: target_name (async)
  ```

#### üé® Smart JSON Output Control

- **Console:** Clean output without JSON clutter
- **Log File:** Full JSON details when `--log-file` specified
- **Debug Mode:** JSON visible with `--debug` flag

#### üìè Extended Display Columns

- **Display-name column:** Expanded to 50 characters (was 30)
- **No more truncation:** Full database names visible

  ```text
  # Before: exa101r04c04_cdb01b04_PKIATL..
  # After:  exa101r04c04_cdb01b04_PKIATLQ
  ```

### 4. Smart Compartment Resolution (DS_ROOT_COMP)

- **Configuration variable** renamed from `DS_ROOT_COMP_OCID` to `DS_ROOT_COMP`
- Now accepts **both** compartment names and OCIDs:

  ```bash
  DS_ROOT_COMP="cmp-lzp-dbso"                          # Name ‚úÖ
  DS_ROOT_COMP="ocid1.compartment.oc1..aaa..."        # OCID ‚úÖ
  ```

- Automatic resolution with caching for performance
- **Migration:** Simply rename the variable in your `.env` file

### 2. Default Compartment Behavior

- Run `ds_target_refresh.sh` **without arguments** to refresh all NEEDS_ATTENTION targets in `DS_ROOT_COMP`
- No more remembering compartment names for daily operations
- Examples:

  ```bash
  # All three are equivalent:
  ds_target_refresh.sh                           # NEW! Uses DS_ROOT_COMP
  ds_target_refresh.sh -c "$DS_ROOT_COMP"
  ds_target_refresh.sh -c cmp-lzp-dbso
  ```

### 3. Centralized Configuration (ORADBA_ETC)

- Support for `ORADBA_ETC` environment variable
- Load configs from centralized location across multiple extensions
- Priority: `$ORADBA_ETC/datasafe.conf` ‚Üí `etc/datasafe.conf` ‚Üí script-specific
- Usage:

  ```bash
  export ORADBA_ETC="/shared/configs"
  ds_target_refresh.sh  # Uses configs from /shared/configs
  ```

## üêõ Critical Bug Fixes

### Fixed: "Error at line 190 (exit code: 0)"

**Problem:** Script exited with error after successful target refresh  
**Root Cause:** Arithmetic expressions `((var++))` return 1 when `var=0` in bash strict mode  
**Solution:** Changed all occurrences to `var=$((var + 1))` pattern

**Affected lines fixed:**

- Line 176: `FAILED_COUNT=$((FAILED_COUNT + 1))`
- Line 190: `SUCCESS_COUNT=$((SUCCESS_COUNT + 1))`
- Line 192: `FAILED_COUNT=$((FAILED_COUNT + 1))`
- Line 255: `current=$((current + 1))`

### Fixed: Error Handler Recursion

**Problem:** Infinite loop when error occurs during error handling  
**Solution:** Added `trap - ERR` at start of `error_handler()` function

## üìù Updated Files

### Configuration

- [`.env`](.env) - Updated variable name and comments
- [`etc/.env.example`](etc/.env.example) - Updated with new DS_ROOT_COMP format

### Scripts

- [`bin/ds_target_refresh.sh`](bin/ds_target_refresh.sh) - v0.2.0
  - Default compartment behavior
  - Arithmetic fixes
  - Updated help text
- [`bin/template.sh`](bin/template.sh) - v0.2.0

### Libraries

- [`lib/oci_helpers.sh`](lib/oci_helpers.sh) - Added `get_root_compartment_ocid()`
- [`lib/common.sh`](lib/common.sh) - Added ORADBA_ETC support, error handler fix

### Documentation

- [`CHANGELOG.md`](CHANGELOG.md) - Complete v0.2.0 changelog
- [`README.md`](README.md) - Updated examples

## üß™ Testing

All changes have been tested:

- ‚úÖ Syntax validation passed
- ‚úÖ Version display correct (0.2.0)
- ‚úÖ Compartment name resolution working
- ‚úÖ OCID detection working
- ‚úÖ Default behavior functional
- ‚úÖ ORADBA_ETC loading confirmed
- ‚úÖ Arithmetic expressions return exit code 0
- ‚úÖ Real refresh operations successful

## üìñ Usage Examples

### Basic Operations

```bash
# Refresh all NEEDS_ATTENTION targets in DS_ROOT_COMP (simplest!)
bin/ds_target_refresh.sh

# Dry-run first to see what will happen
bin/ds_target_refresh.sh --dry-run

# Refresh all ACTIVE targets instead
bin/ds_target_refresh.sh -L ACTIVE

# Specific compartment
bin/ds_target_refresh.sh -c another-compartment

# Specific targets
bin/ds_target_refresh.sh -T target1,target2,target3
```

### With Centralized Config

```bash
# Setup shared config directory
export ORADBA_ETC="/opt/oradba/etc"
echo 'DS_ROOT_COMP="production-compartment"' > "$ORADBA_ETC/datasafe.conf"

# All extensions now use the same config
bin/ds_target_refresh.sh
```

### Debug Mode

```bash
# See detailed resolution and OCI commands
bin/ds_target_refresh.sh --debug

# Or set in config
LOG_LEVEL=DEBUG bin/ds_target_refresh.sh
```

## ‚ö†Ô∏è Breaking Changes

### DS_ROOT_COMP_OCID ‚Üí DS_ROOT_COMP

**Action Required:** Update your `.env` file

**Before:**

```bash
DS_ROOT_COMP_OCID="ocid1.compartment.oc1..aaaaaaaatfyum..."
```

**After (both work):**

```bash
DS_ROOT_COMP="cmp-lzp-dbso"                          # Name (recommended)
DS_ROOT_COMP="ocid1.compartment.oc1..aaaaaaaatfyum..." # OCID (still works)
```

## üöÄ What's Next?

### Planned for v0.3.0

- Migrate additional scripts (ds_target_update_tags.sh, ds_find_untagged_targets.sh)
- Add BATS test framework
- Integration tests for critical paths
- Performance optimizations for bulk operations

### Future Enhancements

- Parallel target processing
- Progress bar for long operations
- JSON output format option
- Extended filtering capabilities

## üìû Support

For issues or questions:

- Check [QUICKREF.md](QUICKREF.md) for quick reference
- See [lib/README.md](lib/README.md) for library documentation
- Review [MIGRATION_COMPLETE.md](MIGRATION_COMPLETE.md) for migration notes

---

**Enjoy the improved Data Safe management experience!** üéâ
