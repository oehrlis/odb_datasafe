# Release Notes v0.17.3

## Highlights

This patch release fixes critical functional bugs in `ds_target_register.sh`, improves
operational observability across all scripts, and systematically eliminates duplicate code
across multiple scripts by extracting shared helpers into `lib/oci_helpers.sh`.

- Fixed missing `vmClusterId` / `pluggableDatabaseId` in Data Safe registration payloads
- Fixed automatic compartment derivation from cluster/host for Exadata Cloud@Customer
- Fixed registration hang and jq parse failure caused by incorrect `--wait-for-state` usage
- Demoted raw OCI command-line strings from `DEBUG` to `TRACE` log level (cleaner `--debug` output)
- Extracted reusable DbNode/VM-cluster helpers to `lib/oci_helpers.sh`
- Extracted five additional cross-script helpers into `lib/oci_helpers.sh`
- Eliminated duplicate DbNode OCI calls when only `--host` is provided
- Redacted credentials from debug payload dumps
- Removed three functions from `ds_target_list.sh` that duplicated existing library equivalents
- Replaced duplicate function bodies in four scripts with thin delegation wrappers

## Changed

### Log level corrections (`lib/oci_helpers.sh`, `bin/ds_target_register.sh`)

- Raw OCI CLI command lines and error-output dumps are now logged at `TRACE` instead of
  `DEBUG` in `oci_exec`, `oci_exec_ro`, `ds_refresh_target`, and `ds_update_target_tags`.
  Running with `--debug` now shows only semantic decisions; `--trace` reveals raw OCI
  command details. Corrected in `bin/ds_target_register.sh` for the validation-entry log
  and JSON payload dump lines as well.

### New library helpers (`lib/oci_helpers.sh`)

Three general-purpose OCI helpers extracted from `ds_target_register.sh` into the library:

- `oci_resolve_dbnode_by_host(host)` — single structured-search call returning raw DbNode
  JSON for caller-controlled field extraction.
- `oci_resolve_compartment_by_dbnode_name(host)` — resolve compartment OCID from a DbNode
  display name (hostname).
- `oci_resolve_vm_cluster_compartment(ocid)` — resolve compartment OCID from a VM-cluster
  OCID with type dispatch (`vmcluster` / `cloudvmcluster`) and fallback to generic search.

### Script delegation (`bin/ds_target_register.sh`)

`resolve_compartment_from_host()` and `resolve_vm_cluster_compartment_ocid()` are now thin
wrappers delegating to the corresponding library functions above.

### Duplicate function removal (`bin/ds_target_list.sh`)

Three private functions in `ds_target_list.sh` were duplicating existing library
equivalents in `lib/oci_helpers.sh` without using them. They have been removed and all
call sites updated to use the library versions:

- `apply_target_filter()` → `ds_filter_targets_json()`: filter is now passed as a
  parameter rather than read from a global, making call sites explicit.
- `load_json_selection()` → `ds_load_targets_json_file()`.
- `save_json_selection()` → `ds_save_targets_json_file()`.

### Additional library helpers (`lib/oci_helpers.sh`)

Five more general-purpose helpers extracted from script bodies into the shared library:

- `ds_is_updatable_lifecycle_state(state)` — returns 0 when a target's lifecycle
  state (`ACTIVE`, `NEEDS_ATTENTION`) permits credential updates; 1 otherwise.
- `ds_is_cdb_root_target(name, ocid)` — detects CDB$ROOT scope via name pattern
  (`_CDBROOT` suffix, fast path) and then via two freeform tags (`DBSec.Container`
  and `DBSec.ContainerType`), matching all tagging conventions in use.
- `ds_build_connector_map(compartment_ocid, use_subtree)` — populates the caller's
  `CONNECTOR_MAP` associative array (OCID → display name) using `oci_exec_ro`; the
  optional `use_subtree` flag adds `--compartment-id-in-subtree true`.
- `ds_write_cred_json_file(path, user, pass)` — writes `{userName, password}` JSON
  to a file via `jq -n`, removing repeated inline `jq` calls from credential setup.
- `ds_resolve_user_for_scope(scope, base_user, prefix)` — normalises a Data Safe
  username for the given scope (`PDB` / `ROOT`): strips or prepends the common-user
  prefix (`C##`) as required.

### Script delegation wrappers

Four scripts replace full function bodies with thin wrappers that delegate to the new
library functions above, keeping local names for backward compatibility:

| Script | Local function | Library function |
| --- | --- | --- |
| `ds_target_update_credentials.sh` | `is_updatable_lifecycle_state()` | `ds_is_updatable_lifecycle_state()` |
| `ds_target_activate.sh` | `is_cdb_root()` | `ds_is_cdb_root_target()` |
| `ds_target_activate.sh` | `resolve_ds_user()` | `ds_resolve_user_for_scope()` |
| `ds_target_details.sh` | `build_connector_map()` | `ds_build_connector_map()` |
| `ds_target_export.sh` | `build_connector_map()` | `ds_build_connector_map()` |

`create_temp_cred_json()` in both `ds_target_activate.sh` and
`ds_target_update_credentials.sh` now calls `ds_write_cred_json_file()` instead of
repeating the inline `jq -n` invocation.

## Fixed

### `ds_target_register.sh` — registration payload (vmClusterId / pluggableDatabaseId)

- Registration payloads for cloud-at-customer now include `vmClusterId` (CDB$ROOT) and
  `pluggableDatabaseId` (PDB scope), fixing OCI `InvalidParameter` errors ("The vm cluster
  id or pluggable database id cannot be null.").

### `ds_target_register.sh` — compartment and cluster derivation

- Automatic compartment derivation now searches configured scopes (`DS_REGISTER_COMPARTMENT`
  and `DS_ROOT_COMP` subtrees) via structured search rather than relying on a single
  root-compartment path.
- VM cluster discovery supports both resource families (`cloud-vm-cluster` and
  `vm-cluster`) for `--cluster` name/OCID resolution, fixing environments where Exadata
  resources are exposed as `vmcluster` rather than `cloudvmcluster`.
- Resolution order now derives VM cluster OCID first (from `--cluster` or `--host`), then
  derives compartment from the cluster, before falling back to configured defaults.
- Host-based compartment and cluster-OCID derivation now issues a **single** DbNode
  structured-search call and extracts both `compartment-id` and `vmClusterId` together,
  eliminating a redundant second OCI call.

### `ds_target_register.sh` — registration wait and result parsing

- Registration no longer uses `--wait-for-state` (which mixed OCI CLI progress output
  `\r100.0%` into the captured JSON result, causing `jq: parse error: Invalid numeric
  literal` failures). Target creation is now submitted asynchronously and the script polls
  `ds_list_targets` every 15 s until the target reaches `ACTIVE` or `FAILED` state
  (max 10 min timeout).

### `ds_target_register.sh` — credential handling

- `credentials.password` is redacted as `"****"` in all `DEBUG`- and `TRACE`-level JSON
  payload dumps, preventing plaintext passwords from appearing in logs.

### `ds_target_register.sh` — OCI call routing

- Cluster and compartment OCI lookups now call `oci_exec_ro search resource structured-search`
  directly instead of routing through `oci_structured_search_query`, ensuring debug/trace
  messages from `oci_exec_ro` are visible and avoiding a missing-function error when only
  the script is deployed without an updated `lib/oci_helpers.sh`.

### `ds_target_refresh.sh` / `lib/oci_helpers.sh`

- Refresh calls that hit OCI "operation already in progress" conflicts are now classified
  before generic OCI failure logging, so expected skip cases no longer emit misleading
  `ERROR` messages and are reported as warning-level skips only.

### `ds_target_list.sh`

- Fixed `--mode problems|health --issue-view details` table alignment when issue labels are
  long by using a wider fixed `Issue` column and truncating overflow labels with ellipsis.

## Testing

- `bats tests/lib_oci_helpers.bats` (pass)
- `bats tests/script_ds_target_register.bats` (pass)
- `make test` — 286/286 tests pass

## Documentation

- Updated `CHANGELOG.md` for release `0.17.3`.
