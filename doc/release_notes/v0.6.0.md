# OraDBA Data Safe Extension v0.6.0

**Release Date:** 2026-01-22

## Overview

Version 0.6.0 introduces **major improvements to script reliability and consistency**.
This release focuses on standardizing compartment/target selection patterns across
all scripts and fixing critical issues with shell arithmetic operations under
`set -e`.

## Major Changes

### **Standardized Compartment/Target Selection Pattern**

All target management scripts now implement a consistent compartment resolution pattern:

- **Explicit `-c` parameter** takes precedence
- **Falls back to `DS_ROOT_COMP`** environment variable
- **Errors if neither available**

This enables the powerful feature: `-T target-name --dry-run` without requiring `-c` parameter.

**Example Usage:**

```bash
# Without -c, uses DS_ROOT_COMP automatically
export DS_ROOT_COMP="ocid1.compartment.oc1....."
ds_target_audit_trail.sh -T my-target-name --dry-run

# Explicit compartment overrides DS_ROOT_COMP
ds_target_audit_trail.sh -T my-target-name -c other-compartment

# Works with compartment only (lists all targets)
ds_target_audit_trail.sh -c my-compartment
```

**Affected Scripts:**

- ds_target_audit_trail.sh
- ds_target_connect_details.sh
- ds_target_delete.sh
- ds_target_details.sh
- ds_target_export.sh
- ds_target_list.sh
- ds_target_list_connector.sh
- ds_target_move.sh
- ds_target_refresh.sh
- ds_target_register.sh
- ds_target_update_connector.sh
- ds_target_update_credentials.sh
- ds_target_update_service.sh
- ds_target_update_tags.sh
- ds_find_untagged_targets.sh
- ds_tg_report.sh

### **Fixed Shell Arithmetic with `set -e`**

Fixed critical issue where arithmetic expressions like `((count++))` would fail with `set -e` when evaluating to 0.

**Change:**

```bash
# ❌ Before (fails with set -e)
((count++))

# ✅ After (works correctly)
count=$((count + 1))
```

**Scripts Fixed:**

- ds_target_audit_trail.sh
- ds_target_delete.sh
- ds_target_details.sh
- ds_target_export.sh
- ds_target_move.sh
- ds_target_update_credentials.sh
- install_datasafe_service.sh
- uninstall_all_datasafe_services.sh

### **Fixed Double Argument Parsing**

Fixed issue in ds_target_audit_trail.sh where arguments were parsed twice, causing inconsistent behavior.

**Impact:** Scripts now properly parse arguments once and validate inputs correctly.

### **New Helper Function: `resolve_compartment_for_operation()`**

Added to `lib/oci_helpers.sh` for consistent compartment resolution:

```bash
# Returns resolved OCID following priority: explicit > DS_ROOT_COMP > error
resolve_compartment_for_operation(compartment)
```

## Features

### Enhanced Script Reliability

- ✅ Consistent error handling across all 16+ target management scripts
- ✅ Proper `set -e` compliance with no arithmetic expression failures
- ✅ Single-pass argument parsing
- ✅ Automatic `DS_ROOT_COMP` fallback for flexible compartment handling

### Developer Experience

- ✅ Simplified compartment resolution pattern reduces code duplication
- ✅ Clear precedence rules: explicit parameter > environment variable > error
- ✅ Improved error messages guide users to configure `DS_ROOT_COMP`

## Technical Details

### Helper Function Pattern

```bash
# In any script's validate_inputs()
COMPARTMENT=$(resolve_compartment_for_operation "$COMPARTMENT") || \
    die "Failed to resolve compartment"

# Now COMPARTMENT is guaranteed to be a valid OCID
```

### Arithmetic Expression Fix

Replaced all post-increment arithmetic in loops:

```bash
# In target processing loops
for target in "${targets[@]}"; do
    # Process target...
    count=$((count + 1))  # Safe with set -e
done
```

## Testing

- ✅ All 18+ scripts pass bash syntax checks
- ✅ Verified end-to-end with: `ds_target_audit_trail.sh -T target --dry-run`
- ✅ Confirmed compartment resolution works with DS_ROOT_COMP fallback
- ✅ Tested arithmetic operations in loops with `set -e`

## Breaking Changes

**None.** This release is fully backward compatible. All script interfaces remain unchanged.

## Migration Guide

No migration needed. Simply upgrade the extension:

```bash
# Extract new version
tar -xzf odb_datasafe-0.6.0.tar.gz

# Existing scripts work as before
# New behavior: scripts accept -T without -c when DS_ROOT_COMP is set
```

## Known Issues

None at this time.

## Future Improvements

- Planned: Enhanced logging in compartment resolution for troubleshooting
- Planned: Extended test coverage for edge cases
- Planned: Documentation for custom script development using new patterns

## Contributors

- Stefan Oehrli (Lead Developer)

## See Also

- [Changelog](../CHANGELOG.md) - Complete version history
- [Quick Reference](../quickref.md) - Script usage reference
- [Installation Guide](../install_datasafe_service.md) - Setup instructions
